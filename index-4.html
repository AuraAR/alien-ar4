<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RECLUSIA - Bioluminescent AR</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
            color: #00ff88;
        }
        #videoContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            /* Fix dark camera */
            filter: brightness(1.3) contrast(1.08) saturate(1.05);
        }
        #arCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10;
        }
        .btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 3px solid #00ff88;
            background: rgba(0,0,0,0.8);
            color: #00ff88;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
            user-select: none;
        }
        .btn:active { transform: scale(0.9); box-shadow: 0 0 25px rgba(0,255,136,0.6); }
        .btn.active  { background: rgba(0,255,136,0.2); box-shadow: 0 0 20px rgba(0,255,136,0.5); }
        .status {
            position: absolute;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            color: #00ff88;
            text-align: center;
            font-size: 12px;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,255,136,0.3);
            z-index: 10;
            white-space: nowrap;
        }
        .start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #000011, #001122, #000033);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
        }
        .start-screen h1 {
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff88;
            letter-spacing: 6px;
            animation: pulse 2s infinite;
        }
        .start-screen p { margin: 10px 0; opacity: 0.8; }
        .start-btn {
            width: 140px; height: 140px;
            border-radius: 50%;
            border: 4px solid #00ff88;
            background: rgba(0,0,0,0.5);
            color: #00ff88;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(0,255,136,0.5);
            transition: all 0.3s ease;
            margin-top: 30px;
        }
        .start-btn:active { transform: scale(0.95); box-shadow: 0 0 40px rgba(0,255,136,0.8); }
        @keyframes pulse {
            0%,100% { opacity:1; transform:scale(1); }
            50%      { opacity:0.7; transform:scale(1.05); }
        }
        .hidden { display: none !important; }
        .camera-switch { position: absolute; top: 20px; right: 20px; z-index: 10; }
        .instructions {
            position: absolute;
            bottom: 120px; left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: rgba(0,255,136,0.7);
            font-size: 11px;
            z-index: 10;
            white-space: nowrap;
        }
        #bassFlash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
            opacity: 0;
            transition: opacity 0.05s;
        }
        @media (max-width: 480px) {
            .start-screen h1 { font-size: 24px; }
            .start-btn { width: 120px; height: 120px; }
            .btn { width: 50px; height: 50px; font-size: 16px; }
            .controls { bottom: 20px; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="start-screen" id="startScreen">
        <h1>RECLUSIA</h1>
        <p style="font-size:18px;margin:15px 0;">ğŸŒ¿ Bioluminescent Soundscapes ğŸŒ¿</p>
        <p style="font-size:14px;margin:20px 0;opacity:0.9;">
            ğŸ“· Camera + ğŸ¤ Microphone access needed<br>
            ğŸ‘† Tap "Allow" when your browser asks
        </p>
        <p style="font-size:12px;margin-bottom:20px;opacity:0.6;">
            Transform into an alien being surrounded by glowing plants
        </p>
        <button class="start-btn" onclick="startAR()">
            <div>ğŸŒŒ</div>
            <div style="margin-top:5px;">ENTER</div>
        </button>
    </div>

    <div id="videoContainer" class="hidden">
        <video id="cameraFeed" autoplay muted playsinline></video>
        <canvas id="arCanvas"></canvas>
        <div id="bassFlash"></div>
    </div>

    <div class="status hidden" id="status">Initializing...</div>

    <div class="controls hidden" id="controls">
        <button class="btn" id="micBtn"    title="Toggle Audio">ğŸ¤</button>
        <button class="btn" id="plantsBtn" title="Toggle Plants">ğŸŒ¿</button>
        <button class="btn" id="alienBtn"  title="Alien Face">ğŸ‘½</button>
        <button class="btn" id="colorBtn"  title="Change Colors">ğŸ¨</button>
    </div>

    <div class="camera-switch hidden" id="cameraSwitch">
        <button class="btn" id="flipBtn" title="Flip Camera">ğŸ”„</button>
    </div>

    <div class="instructions hidden" id="instructions">
        Tap ğŸ¤ for audio reactive mode â€¢ ğŸ‘½ to morph your face
    </div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let video, canvas, ctx;
let audioContext, analyser, microphone;
let plants = [], particles = [];
let micActive = false, cameraActive = false;
let plantsActive = true, alienActive = false;
let facingMode = 'user', currentColors = 0;
let time = 0;
let W = 0, H = 0;

// Face mesh
let faceMesh = null, faceResults = null, faceMeshReady = false, mpCamera = null;

// Smoothed audio
let smoothBass = 0, smoothMid = 0, smoothHigh = 0, smoothAvg = 0;
let lastBassHit = 0;

// â”€â”€â”€ Palettes â€” muted bioluminescent, not neon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const colorPalettes = [
    { stem:'rgba(0,170,130,0.72)',  leaf:'rgba(0,200,155,0.58)', spore:'rgba(80,240,185,0.48)', glow:'#00aa82', flash:'rgba(0,170,130,0.07)' },
    { stem:'rgba(110,55,195,0.68)', leaf:'rgba(150,75,230,0.52)', spore:'rgba(190,130,255,0.45)', glow:'#8040c0', flash:'rgba(110,55,195,0.07)' },
    { stem:'rgba(195,130,18,0.68)', leaf:'rgba(230,168,35,0.52)', spore:'rgba(255,210,90,0.45)', glow:'#c08010', flash:'rgba(195,130,18,0.07)' },
    { stem:'rgba(50,165,245,0.68)', leaf:'rgba(90,200,255,0.52)', spore:'rgba(170,235,255,0.45)', glow:'#32a0f0', flash:'rgba(50,165,245,0.07)' },
    { stem:'rgba(210,72,110,0.68)', leaf:'rgba(248,110,150,0.52)', spore:'rgba(255,170,195,0.45)', glow:'#d04870', flash:'rgba(210,72,110,0.07)' }
];

// â”€â”€â”€ MediaPipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFaceMesh() {
    if (typeof FaceMesh === 'undefined') { console.warn('MediaPipe unavailable'); return; }
    faceMesh = new FaceMesh({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
    });
    faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
    faceMesh.onResults(r => { faceResults = r; });
    faceMeshReady = true;
}

function startFaceMeshCamera() {
    if (!faceMeshReady || !faceMesh || typeof Camera === 'undefined') return;
    mpCamera = new Camera(video, {
        onFrame: async () => { if (alienActive && faceMesh) await faceMesh.send({ image: video }); },
        width: 640, height: 480
    });
    mpCamera.start();
}

// â”€â”€â”€ App Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startAR() {
    try {
        document.getElementById('startScreen').classList.add('hidden');
        ['videoContainer','status','controls','cameraSwitch','instructions'].forEach(id =>
            document.getElementById(id).classList.remove('hidden'));
        await initCamera();
        await initAudio();
        initFaceMesh();
        setupControls();
        startAnimation();
        generateInitialPlants();
    } catch(e) {
        console.error(e);
        showError('Failed to initialize. Check camera permissions.');
    }
}

async function initCamera() {
    video  = document.getElementById('cameraFeed');
    canvas = document.getElementById('arCanvas');
    ctx    = canvas.getContext('2d');
    updateStatus('Requesting camera...');
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width:{ideal:1280}, height:{ideal:720} }
    });
    video.srcObject = stream;
    cameraActive = true;
    updateStatus('ğŸŒ¿ AR Active â€” tap ğŸ‘½ to morph');
    video.addEventListener('loadedmetadata', resizeCanvas);
}

async function initAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.78;
    } catch(e) { console.error('Audio init:', e); }
}

function resizeCanvas() {
    const r = video.getBoundingClientRect();
    W = canvas.width  = r.width  || window.innerWidth;
    H = canvas.height = r.height || window.innerHeight;
    generateInitialPlants();
}

function updateStatus(msg) {
    const el = document.getElementById('status');
    el.textContent = msg; el.style.opacity = '1';
    setTimeout(() => el.style.opacity = '0.6', 3000);
}
function showError(m) { updateStatus('âŒ ' + m); }

function setupControls() {
    document.getElementById('micBtn').onclick    = toggleMicrophone;
    document.getElementById('plantsBtn').onclick = togglePlants;
    document.getElementById('alienBtn').onclick  = toggleAlienMode;
    document.getElementById('colorBtn').onclick  = switchColors;
    document.getElementById('flipBtn').onclick   = flipCamera;
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
}

async function toggleMicrophone() {
    const btn = document.getElementById('micBtn');
    if (!micActive) {
        try {
            if (audioContext?.state === 'suspended') await audioContext.resume();
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }
            });
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            micActive = true; btn.classList.add('active');
            updateStatus('ğŸµ Audio reactive ON');
        } catch(e) { updateStatus('âŒ Mic denied'); }
    } else {
        microphone?.disconnect(); microphone = null;
        micActive = false; btn.classList.remove('active');
        updateStatus('ğŸ”‡ Audio OFF');
    }
}

function togglePlants() {
    const btn = document.getElementById('plantsBtn');
    plantsActive = !plantsActive;
    if (plantsActive) { btn.classList.add('active'); generateInitialPlants(); updateStatus('ğŸŒ¿ Plants growing'); }
    else              { btn.classList.remove('active'); plants = []; updateStatus('ğŸŒ‘ Plants off'); }
}

function toggleAlienMode() {
    const btn = document.getElementById('alienBtn');
    alienActive = !alienActive;
    if (alienActive) {
        btn.classList.add('active');
        updateStatus('ğŸ‘½ Alien mode â€” face the camera');
        if (faceMeshReady && !mpCamera) startFaceMeshCamera();
    } else {
        btn.classList.remove('active');
        faceResults = null;
        updateStatus('ğŸ‘¤ Human restored');
    }
}

function switchColors() {
    currentColors = (currentColors + 1) % colorPalettes.length;
    updateStatus('ğŸ¨ ' + ['Pandora','Violet','Amber','Arctic','Coral'][currentColors]);
}

async function flipCamera() {
    facingMode = facingMode === 'user' ? 'environment' : 'user';
    video.srcObject?.getTracks().forEach(t => t.stop());
    try {
        video.srcObject = await navigator.mediaDevices.getUserMedia({
            video: { facingMode, width:{ideal:1280}, height:{ideal:720} }
        });
        updateStatus(facingMode === 'user' ? 'ğŸ¤³ Front' : 'ğŸ“· Back');
    } catch(e) {
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        updateStatus('âŒ Flip failed');
    }
}

// â”€â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAudioData() {
    time += 0.016;
    if (!analyser || !micActive) {
        const d = { bass:0.14+Math.sin(time*0.6)*0.06, mid:0.11+Math.sin(time*1.0)*0.05, high:0.08+Math.sin(time*2.1)*0.04, average:0.11+Math.sin(time*1.3)*0.05 };
        doSmooth(d); return d;
    }
    const buf = analyser.frequencyBinCount, data = new Uint8Array(buf);
    analyser.getByteFrequencyData(data);
    const d = { bass:avg(data,0,Math.floor(buf*0.15)), mid:avg(data,Math.floor(buf*0.15),Math.floor(buf*0.5)), high:avg(data,Math.floor(buf*0.5),buf), average:avg(data,0,buf) };
    doSmooth(d); return d;
}
function doSmooth(d) {
    const k = 0.13;
    smoothBass = smoothBass+(d.bass-smoothBass)*k; smoothMid = smoothMid+(d.mid-smoothMid)*k;
    smoothHigh = smoothHigh+(d.high-smoothHigh)*k; smoothAvg = smoothAvg+(d.average-smoothAvg)*k;
}
function avg(arr,s,e) { let sum=0; for(let i=s;i<e;i++) sum+=arr[i]; return (sum/(e-s))/255; }

// â”€â”€â”€ Plants â€” Avatar / Pandora style â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateInitialPlants() {
    if (!plantsActive || !W) return;
    plants = [];
    for (let i=0;i<11;i++) plants.push(makePlant('bottom', Math.random()*W));
    for (let i=0;i<3;i++)  plants.push(makePlant('left',   H*(0.4+Math.random()*0.5)));
    for (let i=0;i<3;i++)  plants.push(makePlant('right',  H*(0.4+Math.random()*0.5)));
}

function makePlant(edge, pos) {
    const types = ['frond','frond','tendril','pod','wisp','spine'];
    let x, y, dir;
    if      (edge==='bottom') { x=pos; y=H; dir='up'; }
    else if (edge==='left')   { x=0;   y=pos; dir='right'; }
    else                      { x=W;   y=pos; dir='left'; }
    return {
        x, y, edge, dir,
        type: types[Math.floor(Math.random()*types.length)],
        size:       0.28+Math.random()*0.72,
        depth:      Math.random(),
        baseLen:    38+Math.random()*85,
        swayPhase:  Math.random()*Math.PI*2,
        glowSeed:   Math.random(),
        segments:   4+Math.floor(Math.random()*5),
        swayAmt:    0, currentLen:1, currentGlow:0.2,
        birthTime:  time
    };
}

function updatePlants() {
    if (!plantsActive) return;
    plants.forEach(p => {
        const age      = time - p.birthTime;
        const growFrac = Math.min(age/2.8, 1.0);
        const audioSway = smoothBass*1.6 + smoothMid*0.5;
        p.swayAmt     = Math.sin(time*1.5+p.swayPhase) * (0.22+audioSway) * growFrac;
        p.currentGlow = (0.22+p.glowSeed*0.28) * (1+smoothAvg*1.1) * growFrac;
        const breathe  = smoothBass > 0.32 ? (smoothBass-0.32)*0.55 : 0;
        p.currentLen   = p.baseLen*p.size*growFrac*(1+breathe);
    });
}

function drawFrond(x, y, len, angle, pal, alpha, lineW) {
    if (len < 2) return;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = pal.stem;
    ctx.lineWidth   = lineW;
    ctx.lineCap     = 'round';
    ctx.shadowColor = pal.glow;
    ctx.shadowBlur  = 5 + smoothAvg*9;

    const ex   = x + Math.cos(angle)*len;
    const ey   = y + Math.sin(angle)*len;
    const cx1  = x + Math.cos(angle+0.38)*len*0.48;
    const cy1  = y + Math.sin(angle+0.38)*len*0.48;

    ctx.beginPath(); ctx.moveTo(x,y); ctx.quadraticCurveTo(cx1,cy1,ex,ey); ctx.stroke();

    // Leaf pairs
    const lc = Math.floor(len/20);
    for (let i=1;i<lc;i++) {
        const t  = i/lc;
        const lx = x+(ex-x)*t+(cx1-x)*t*(1-t)*2;
        const ly = y+(ey-y)*t+(cy1-y)*t*(1-t)*2;
        const ls = (2.5+t*4.5)*(lineW*0.55);
        ctx.fillStyle   = pal.leaf;
        ctx.shadowColor = pal.glow;
        ctx.shadowBlur  = 3;
        ctx.globalAlpha = alpha*0.65;
        [-1,1].forEach(side => {
            ctx.beginPath();
            ctx.ellipse(lx+Math.cos(angle+side*Math.PI/2.1)*ls, ly+Math.sin(angle+side*Math.PI/2.1)*ls, ls*0.85, ls*0.38, angle+side*0.55, 0, Math.PI*2);
            ctx.fill();
        });
    }

    // Tip spore
    ctx.globalAlpha  = alpha*(0.45+smoothAvg*0.45);
    ctx.fillStyle    = pal.spore;
    ctx.shadowBlur   = 10+smoothAvg*14;
    ctx.shadowColor  = pal.glow;
    ctx.beginPath(); ctx.arc(ex,ey, 2+p_bassR(), 0, Math.PI*2); ctx.fill();
    ctx.restore();
}

function p_bassR() { return smoothBass*2.5; }

function renderPlants() {
    if (!plantsActive) return;
    const pal = colorPalettes[currentColors];
    [...plants].sort((a,b)=>a.depth-b.depth).forEach(p => {
        if (p.currentLen < 2) return;
        const alpha  = (0.32+p.depth*0.42)*Math.min((time-p.birthTime)/1.8,1);
        const lineW  = 1.1+p.depth*1.6;
        let baseAngle;
        if      (p.dir==='up')    baseAngle = -Math.PI/2+p.swayAmt;
        else if (p.dir==='right') baseAngle =  0+p.swayAmt;
        else                      baseAngle =  Math.PI+p.swayAmt;

        drawFrond(p.x,p.y,p.currentLen,baseAngle,pal,alpha,lineW);

        if (p.type==='frond'||p.type==='spine') {
            drawFrond(p.x,p.y,p.currentLen*0.52,baseAngle-0.42,pal,alpha*0.6,lineW*0.65);
            drawFrond(p.x,p.y,p.currentLen*0.52,baseAngle+0.42,pal,alpha*0.6,lineW*0.65);
        }

        if (p.type==='pod') {
            const tx=p.x+Math.cos(baseAngle)*p.currentLen, ty=p.y+Math.sin(baseAngle)*p.currentLen;
            ctx.save();
            ctx.globalAlpha=alpha*(0.55+smoothAvg*0.35);
            ctx.fillStyle=pal.leaf; ctx.shadowColor=pal.glow; ctx.shadowBlur=16+smoothBass*18;
            ctx.beginPath(); ctx.arc(tx,ty,4+p.size*5+smoothBass*3,0,Math.PI*2); ctx.fill();
            ctx.restore();
        }

        if (p.type==='wisp'&&Math.random()<0.035+smoothAvg*0.08) {
            const tx=p.x+Math.cos(baseAngle)*p.currentLen*(0.5+Math.random()*0.5);
            const ty=p.y+Math.sin(baseAngle)*p.currentLen*(0.5+Math.random()*0.5);
            particles.push({ x:tx,y:ty, vx:(Math.random()-0.5)*0.5, vy:-0.35-Math.random()*0.5, size:0.8+Math.random()*1.8, color:pal.spore, glow:pal.glow, life:1.0, fadeRate:0.009 });
        }
    });
}

// â”€â”€â”€ Alien Face â€” natural morph + bug antennae â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OUTLINE = [10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109];
const L_EYE   = [33,7,163,144,145,153,154,155,133,173,157,158,159,160,161,246];
const R_EYE   = [362,382,381,380,374,373,390,249,263,466,388,387,386,385,384,398];

function lm(lms, idx) { const l=lms[idx]; return { x:(1-l.x)*W, y:l.y*H }; }

function renderAlienFace() {
    if (!alienActive) return;
    if (faceResults?.multiFaceLandmarks?.length > 0) {
        drawTrackedAlien(faceResults.multiFaceLandmarks[0]);
    } else {
        ctx.save();
        ctx.globalAlpha = 0.38+Math.sin(time*1.8)*0.08;
        ctx.fillStyle   = colorPalettes[currentColors].spore;
        ctx.font        = '11px Courier New';
        ctx.textAlign   = 'center';
        ctx.fillText('FACE CAMERA TO ACTIVATE', W/2, H/2+55);
        ctx.restore();
    }
}

function drawTrackedAlien(lms) {
    const top     = lm(lms,10);
    const bottom  = lm(lms,152);
    const faceH   = bottom.y - top.y;
    const centerX = (top.x+bottom.x)/2;
    const pal     = colorPalettes[currentColors];

    ctx.save();
    ctx.globalCompositeOperation = 'source-over';

    // â”€â”€ 1. Elongated skull overlay (skin-toned, no color) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const elongation = 0.26 + smoothBass*0.1;
    const skullTop   = top.y - faceH*elongation;
    const skullW     = faceH*0.41;
    const skullH     = (bottom.y - skullTop)*0.52;

    const grad = ctx.createRadialGradient(centerX, skullTop+skullH*0.55, skullH*0.08, centerX, skullTop+skullH*0.55, skullH*1.05);
    grad.addColorStop(0,   'rgba(155,125,105,0.5)');
    grad.addColorStop(0.55,'rgba(135,105,85,0.3)');
    grad.addColorStop(1,   'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.shadowColor='transparent'; ctx.shadowBlur=0;
    ctx.beginPath();
    ctx.ellipse(centerX, skullTop+skullH*0.52, skullW, skullH, 0, 0, Math.PI*2);
    ctx.fill();

    // Very faint temple veins
    ctx.strokeStyle='rgba(70,45,25,0.15)'; ctx.lineWidth=0.7; ctx.globalAlpha=0.28+smoothMid*0.18;
    for (let v=0;v<3;v++) {
        const ox=(v-1)*skullW*0.32;
        ctx.beginPath();
        ctx.moveTo(centerX+ox, top.y);
        ctx.quadraticCurveTo(centerX+ox*1.15, skullTop+skullH*0.38, centerX+ox*0.5, skullTop+2);
        ctx.stroke();
    }

    // â”€â”€ 2. Dark almond eyes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    [[L_EYE],[R_EYE]].forEach(([eyeIdx]) => {
        const pts = eyeIdx.map(i=>lm(lms,i));
        const ex  = pts.reduce((s,p)=>s+p.x,0)/pts.length;
        const ey  = pts.reduce((s,p)=>s+p.y,0)/pts.length;
        const ew  = Math.abs(pts[0].x-pts[8].x)*(1.55+smoothBass*0.35);
        const eh  = ew*0.52;

        // Dark iris
        ctx.globalAlpha=0.80; ctx.fillStyle='#08060a'; ctx.shadowColor='transparent'; ctx.shadowBlur=0;
        ctx.beginPath(); ctx.ellipse(ex,ey,ew,eh,0,0,Math.PI*2); ctx.fill();

        // Iridescent sheen
        ctx.globalAlpha=0.22+smoothAvg*0.18; ctx.fillStyle=pal.glow;
        ctx.beginPath(); ctx.ellipse(ex,ey,ew*0.58,eh*0.52,0,0,Math.PI*2); ctx.fill();

        // Catchlight
        ctx.globalAlpha=0.68; ctx.fillStyle='rgba(255,255,255,0.88)'; ctx.shadowBlur=0;
        ctx.beginPath(); ctx.ellipse(ex-ew*0.21,ey-eh*0.23,ew*0.09,eh*0.1,0,0,Math.PI*2); ctx.fill();
    });

    // â”€â”€ 3. Bug antennae â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.globalAlpha=1;
    const antLen  = faceH*(0.52+smoothMid*0.18) + smoothBass*faceH*0.14;
    const antPairs = [
        { bx: top.x - faceH*0.17, by: top.y+2, tipXOffset: -faceH*0.20, sway:-1 },
        { bx: top.x + faceH*0.17, by: top.y+2, tipXOffset:  faceH*0.20, sway: 1 }
    ];

    antPairs.forEach(ant => {
        const tipX = ant.bx + ant.tipXOffset + Math.sin(time*2.0+ant.sway)*5;
        const tipY = ant.by - antLen;
        const ctrlX= ant.bx + (tipX-ant.bx)*0.38 + ant.sway*8;
        const ctrlY= ant.by - antLen*0.52;

        // Main shaft
        ctx.lineWidth=1.6; ctx.strokeStyle='rgba(35,22,14,0.88)';
        ctx.shadowColor='transparent'; ctx.shadowBlur=0;
        ctx.globalAlpha=0.88; ctx.lineCap='round';
        ctx.beginPath(); ctx.moveTo(ant.bx,ant.by); ctx.quadraticCurveTo(ctrlX,ctrlY,tipX,tipY); ctx.stroke();

        // Subtle highlight edge
        ctx.lineWidth=0.5; ctx.strokeStyle='rgba(210,185,155,0.28)';
        ctx.beginPath(); ctx.moveTo(ant.bx+1,ant.by); ctx.quadraticCurveTo(ctrlX+1,ctrlY,tipX+1,tipY); ctx.stroke();

        // Bulb
        const br = 3.2+smoothBass*2.2;
        ctx.globalAlpha=0.90; ctx.fillStyle='#150c06'; ctx.shadowColor='transparent'; ctx.shadowBlur=0;
        ctx.beginPath(); ctx.arc(tipX,tipY,br,0,Math.PI*2); ctx.fill();

        // Iridescent sheen on bulb
        ctx.globalAlpha=0.48+smoothAvg*0.28; ctx.fillStyle=pal.glow;
        ctx.shadowColor=pal.glow; ctx.shadowBlur=7+smoothAvg*9;
        ctx.beginPath(); ctx.arc(tipX,tipY,br*0.62,0,Math.PI*2); ctx.fill();

        // Specular
        ctx.globalAlpha=0.75; ctx.fillStyle='#fff'; ctx.shadowBlur=0;
        ctx.beginPath(); ctx.arc(tipX-br*0.24,tipY-br*0.26,br*0.21,0,Math.PI*2); ctx.fill();
    });

    ctx.restore();
}

// â”€â”€â”€ Bass Flash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerBassFlash() {
    if (!micActive) return;
    const now = Date.now();
    if (smoothBass>0.50 && now-lastBassHit>130) {
        lastBassHit=now;
        const flash=document.getElementById('bassFlash');
        flash.style.background=`radial-gradient(ellipse at center, ${colorPalettes[currentColors].flash} 0%, transparent 70%)`;
        flash.style.opacity=(smoothBass*0.65).toString();
        setTimeout(()=>flash.style.opacity='0',90);
    }
}

// â”€â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addParticleEffects() {
    const pal  = colorPalettes[currentColors];
    const rate = micActive ? 0.18+smoothAvg*0.7 : 0.04;
    if (Math.random()<rate) {
        particles.push({ x:Math.random()*W, y:H+8, vx:(Math.random()-0.5)*1.0, vy:-0.5-Math.random()*1.2-smoothBass*1.2, size:0.8+Math.random()*1.8+smoothBass*1.5, color:pal.spore, glow:pal.glow, life:1.0, fadeRate:0.005+Math.random()*0.007 });
    }
    if (smoothBass>0.46&&Math.random()<0.45) {
        for (let i=0;i<4;i++) particles.push({ x:W/2+(Math.random()-0.5)*220, y:H/2+(Math.random()-0.5)*220, vx:(Math.random()-0.5)*4.5, vy:(Math.random()-0.5)*4.5, size:1.2+Math.random()*2.5, color:pal.spore, glow:pal.glow, life:1.0, fadeRate:0.020 });
    }
    for (let i=particles.length-1;i>=0;i--) {
        const p=particles[i];
        p.x+=p.vx; p.y+=p.vy; p.life-=p.fadeRate;
        if (p.life<=0||p.y<-40||p.x<-40||p.x>W+40) particles.splice(i,1);
    }
}

function renderParticles() {
    particles.forEach(p => {
        ctx.save();
        ctx.globalAlpha=p.life*0.7; ctx.fillStyle=p.color;
        ctx.shadowColor=p.glow; ctx.shadowBlur=5+smoothBass*8;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
        ctx.restore();
    });
}

// â”€â”€â”€ Render Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    if (!ctx||!canvas) return;
    ctx.clearRect(0,0,W,H);
    ctx.globalCompositeOperation='screen';
    renderPlants();
    renderParticles();
    ctx.globalCompositeOperation='source-over';
    renderAlienFace();
}

function startAnimation() {
    function animate() {
        if (cameraActive) {
            getAudioData();
            updatePlants();
            addParticleEffects();
            triggerBassFlash();
            render();
            if (particles.length>220) particles.splice(0,particles.length-220);
        }
        requestAnimationFrame(animate);
    }
    animate();
}

setInterval(() => {
    if (!plantsActive||!W) return;
    if (plants.length<18) {
        const edges=['bottom','bottom','bottom','left','right'];
        const edge=edges[Math.floor(Math.random()*edges.length)];
        const pos=edge==='bottom'?Math.random()*W:H*(0.35+Math.random()*0.55);
        plants.push(makePlant(edge,pos));
    }
}, 3200);

document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
document.addEventListener('gesturestart',e=>e.preventDefault());
document.addEventListener('gesturechange',e=>e.preventDefault());
window.addEventListener('orientationchange',()=>setTimeout(resizeCanvas,500));
</script>
</body>
</html>
